name: Deploy Query Manager to AWS Lambda

on:
  push:
    branches:
      - LEV-389_workflow_CICD_pipeline
#    paths:
#        - 'query_manager/**'
  # In case of a merge to main branch we will deploy all the modules
  # pull_request:
  #   types: [closed]
  #   branches:
  #     - main

permissions:
  id-token: write
  contents: read

jobs:

  generate-tag:
    name: generate-tag
    runs-on: ubuntu-latest
    outputs:
      tag_id: ${{ steps.generate-tag.outputs.tag_id }}
    steps:
      - name: Generate TAG
        id: generate-tag
        run: |
          echo "tag_id=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_OUTPUT

  build-query-manager-image:
    needs: generate-tag
    uses: ./.github/workflows/reusable-build-image.yml
    with:
        ecr_repo: 'query-manager'
        app_name: 'query_manager'
        tag: ${{ needs.generate-tag.outputs.tag_id }}

    secrets:
      ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      DEV_DEPLOYMENT_ROLE: ${{ secrets.DEV_DEPLOYMENT_ROLE }}

  deploy-query-manager-image-on-lambda:
    needs: [build-query-manager-image, generate-tag]
    uses: ./.github/workflows/reusable-lambda-deployment.yml
    with:
      ecr_repo: 'query-manager'
      app_lambda_function_name: 'query-manager-dev'
      tag: ${{ needs.generate-tag.outputs.tag_id }}
    secrets:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      DEV_DEPLOYMENT_ROLE: ${{ secrets.DEV_DEPLOYMENT_ROLE }}
      ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
