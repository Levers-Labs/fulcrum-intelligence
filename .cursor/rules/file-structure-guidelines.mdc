---
description:
globs:
alwaysApply: false
---
# File Structure Guidelines

## ðŸ—ï¸ Project Structure

**Microservices monorepo** with clear service boundaries

```
fulcrum-intelligence/
â”œâ”€â”€ commons/                # Shared libraries (auth, db, clients)
â”œâ”€â”€ core/                   # Analytics engine library
â”œâ”€â”€ levers/                 # Analytics primitives library
â”œâ”€â”€ analysis_manager/       # FastAPI service (8000)
â”œâ”€â”€ query_manager/          # FastAPI service (8001)
â”œâ”€â”€ story_manager/          # FastAPI service (8002)
â”œâ”€â”€ insights_backend/       # FastAPI service (8004)
â”œâ”€â”€ tasks_manager/          # Prefect orchestration
â”œâ”€â”€ docker-compose.yml      # Local development
â”œâ”€â”€ Makefile                # Development commands
â””â”€â”€ README.md              # Project documentation
```

## ðŸ“¦ Service Template

**FastAPI Services** follow consistent structure:

```
service_name/
â”œâ”€â”€ service_name/           # Main package
â”‚   â”œâ”€â”€ main.py            # FastAPI app
â”‚   â”œâ”€â”€ config.py          # Settings
â”‚   â”œâ”€â”€ exceptions.py      # Custom exceptions
â”‚   â”œâ”€â”€ core/              # Business logic
â”‚   â”‚   â”œâ”€â”€ models.py      # SQLModel database models
â”‚   â”‚   â”œâ”€â”€ schemas.py     # Pydantic API schemas
â”‚   â”‚   â”œâ”€â”€ routes.py      # Route handlers
â”‚   â”‚   â”œâ”€â”€ dependencies.py # DI functions
â”‚   â”‚   â””â”€â”€ services/      # Business services
â”‚   â””â”€â”€ db/
â”‚       â””â”€â”€ config.py      # Database session
â”œâ”€â”€ tests/                 # Test suite
â”‚   â”œâ”€â”€ unit/              # Unit tests
â”‚   â””â”€â”€ integration/       # Integration tests
â”œâ”€â”€ migrations/            # Alembic migrations
â”œâ”€â”€ Dockerfile            # Container definition
â”œâ”€â”€ manage.py             # Service CLI
â”œâ”€â”€ pyproject.toml        # Dependencies
â””â”€â”€ README.md             # Service docs
```

## ðŸ“š Shared Libraries

### Commons Structure
```
commons/
â”œâ”€â”€ commons/
â”‚   â”œâ”€â”€ auth/              # Authentication utilities
â”‚   â”œâ”€â”€ clients/           # HTTP clients for services
â”‚   â”œâ”€â”€ db/                # Database utilities
â”‚   â”œâ”€â”€ exceptions.py      # Common exceptions
â”‚   â”œâ”€â”€ middleware/        # FastAPI middleware
â”‚   â”œâ”€â”€ models/            # Shared models
â”‚   â””â”€â”€ utilities/         # Utility functions
â””â”€â”€ tests/                 # Commons tests
```

### Core Structure
```
core/
â”œâ”€â”€ fulcrum_core/
â”‚   â”œâ”€â”€ modules/           # Analytics modules
â”‚   â”‚   â”œâ”€â”€ describe.py
â”‚   â”‚   â”œâ”€â”€ forecast.py
â”‚   â”‚   â””â”€â”€ process_control.py
â”‚   â””â”€â”€ analysis_manager.py # Main interface
â””â”€â”€ tests/                 # Core tests
```

### Levers Structure
```
levers/
â”œâ”€â”€ levers/
â”‚   â”œâ”€â”€ patterns/          # Analysis patterns
â”‚   â”œâ”€â”€ primitives/        # Analytics primitives
â”‚   â””â”€â”€ api.py            # Main API
â””â”€â”€ tests/                # Levers tests
```

## ðŸ“„ File Naming

- **Python files**: `user_service.py`, `component_drift.py`
- **Directories**: `services/`, `models/`, `tests/`
- **Config files**: `.env.template`, `config.py`
- **Tests**: `test_` prefix, mirror source structure

## ðŸŽ¯ Service-Specific Patterns

### Analysis Manager
```
analysis_manager/
â”œâ”€â”€ analysis_manager/
â”‚   â”œâ”€â”€ patterns/          # Pattern analysis
â”‚   â”‚   â”œâ”€â”€ crud/
â”‚   â”‚   â”œâ”€â”€ manager.py
â”‚   â”‚   â””â”€â”€ models/
â”‚   â””â”€â”€ data/
â”‚       â””â”€â”€ pattern_configs.json
```

### Query Manager
```
query_manager/
â”œâ”€â”€ query_manager/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ cube.py       # Cube API
â”‚   â”‚   â””â”€â”€ query_client.py
â”‚   â”œâ”€â”€ semantic_manager/ # Semantic models
â”‚   â””â”€â”€ data/
â”‚       â”œâ”€â”€ metrics.json
â”‚       â””â”€â”€ dimensions.json
```

### Story Manager
```
story_manager/
â”œâ”€â”€ story_manager/
â”‚   â”œâ”€â”€ story_builder/    # Story generation
â”‚   â”œâ”€â”€ story_evaluator/  # Story evaluation
â”‚   â””â”€â”€ mocks/            # Mock data
```

### Tasks Manager (Prefect)
```
tasks_manager/
â”œâ”€â”€ tasks_manager/
â”‚   â”œâ”€â”€ flows/            # Prefect flows
â”‚   â”œâ”€â”€ tasks/            # Prefect tasks
â”‚   â””â”€â”€ services/         # Service layer
â”œâ”€â”€ prefect_data/         # Local database
â””â”€â”€ scripts/
    â””â”€â”€ setup_prefect.sh
```

## ðŸ§ª Test Structure

```
tests/
â”œâ”€â”€ unit/                  # Fast, isolated tests
â”‚   â”œâ”€â”€ conftest.py       # Test config
â”‚   â”œâ”€â”€ core/             # Core logic tests
â”‚   â””â”€â”€ services/         # Service tests
â”œâ”€â”€ integration/          # Slower, realistic tests
â””â”€â”€ fixtures/             # Test data
```

## ðŸ”§ Configuration

### Environment Files
```
# .env.template (commit)
ENV=dev
DATABASE_URL=postgresql://...
AUTH0_CLIENT_ID=...

# .env (never commit)
# Copy from template, fill real values
```

### Poetry Configuration
```toml
# pyproject.toml
[tool.poetry.dependencies]
python = ">=3.10,<3.12"

[tool.pytest.ini_options]
addopts = "--cov=service_name"
```

## ðŸ“‹ Best Practices

### Organization
- **Single responsibility** per file
- **Logical grouping** in directories
- **Consistent naming** across services
- **Clear hierarchy** with proper nesting

### Dependencies
- **Poetry** for dependency management
- **Local packages** by path reference
- **Shared dependencies** in commons

### Documentation
- **README** per service
- **Docstrings** for functions
- **API docs** auto-generated
