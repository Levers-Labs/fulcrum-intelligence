.PHONY: help setup up down logs build clean status health test-services
DAGSTER_HOME:=$(shell pwd)/.dagster

# Default target
help:
	@echo ""
	@echo "ğŸ³ Asset Manager Docker Compose Commands"
	@echo "======================================="
	@echo ""
	@echo "Setup Commands:"
	@echo "  setup              - Copy env template and instructions"
	@echo "  build              - Build Docker images"
	@echo ""
	@echo "Service Commands:"
	@echo "  dev                - Start all services in development mode"
	@echo "  up                 - Start all services"
	@echo "  down               - Stop all services"
	@echo "  restart            - Restart all services"
	@echo "  status             - Show service status"
	@echo ""
	@echo "Development Commands:"
	@echo "  logs               - View all service logs"
	@echo "  logs-web           - View web server logs only"
	@echo "  logs-daemon        - View daemon logs only"
	@echo "  logs-db            - View database logs only"
	@echo ""
	@echo "Maintenance Commands:"
	@echo "  health             - Check service health"
	@echo "  test-services      - Test connection to Fulcrum services"
	@echo "  clean              - Remove all containers and volumes"
	@echo "  reset              - Clean and restart everything"
	@echo ""
	@echo "Database Commands:"
	@echo "  db-shell           - Connect to PostgreSQL shell"
	@echo "  db-backup          - Backup Dagster database"
	@echo ""
	@echo "ğŸŒ Access Points:"
	@echo "  Dagster UI:        http://localhost:3000"
	@echo "  PostgreSQL:        localhost:5439 (dagster/dagster_password)"
	@echo ""

# Setup environment
setup:
	@echo "ğŸ“‹ Environment setup..."
	@if [ -f .env ]; then \
		echo "âœ… Using existing .env file"; \
		echo "ğŸ”§ Next steps:"; \
		echo "1. Ensure Fulcrum services are running locally"; \
		echo "2. Verify Auth0 credentials in .env"; \
		echo "3. Run 'make up' to start services"; \
		echo ""; \
	else \
		echo "âŒ .env file not found"; \
		echo "Please create .env file with required configuration"; \
	fi

dev:
	@echo "ğŸš€ Starting Asset Manager services in development mode..."
	@if [ ! -d $(DAGSTER_HOME) ]; then \
		mkdir -p $(DAGSTER_HOME); \
	fi
	DAGSTER_HOME=$(DAGSTER_HOME) dagster dev --host 0.0.0.0 --port 3000 -w workspace.yaml

# Build images
build:
	@echo "ğŸ—ï¸  Building Docker images..."
	docker-compose build

# Start services
up:
	@echo "ğŸš€ Starting Asset Manager services..."
	docker-compose up -d
	@echo "âœ… Services started"
	@echo "ğŸŒ Dagster UI: http://localhost:3000"

# Stop services
down:
	@echo "ğŸ›‘ Stopping Asset Manager services..."
	docker-compose down
	@echo "âœ… Services stopped"

# Restart services
restart: down up

# Show service status
status:
	@echo "ğŸ“Š Service Status:"
	docker-compose ps

# View logs
logs:
	@echo "ğŸ“‹ Following all service logs (Ctrl+C to exit)..."
	docker-compose logs -f

logs-web:
	@echo "ğŸ“‹ Following web server logs (Ctrl+C to exit)..."
	docker-compose logs -f asset-manager-web

logs-daemon:
	@echo "ğŸ“‹ Following daemon logs (Ctrl+C to exit)..."
	docker-compose logs -f asset-manager-daemon

logs-db:
	@echo "ğŸ“‹ Following database logs (Ctrl+C to exit)..."
	docker-compose logs -f postgres

# Check service health
health:
	@echo "ğŸ¥ Checking service health..."
	@echo ""
	@echo "PostgreSQL:"
	@docker-compose exec postgres pg_isready -U dagster -d dagster || echo "âŒ Database not ready"
	@echo ""
	@echo "Dagster Web Server:"
	@curl -s -f http://localhost:3000/server_info > /dev/null && echo "âœ… Web server healthy" || echo "âŒ Web server not responding"
	@echo ""
	@echo "Docker containers:"
	@docker-compose ps

# Test connections to Fulcrum services
test-services:
	@echo "ğŸ” Testing connections to Fulcrum services..."
	@echo ""
	@echo "Analysis Manager (port 8000):"
	@curl -s -f http://localhost:8000/health > /dev/null && echo "âœ… Connected" || echo "âŒ Not available"
	@echo "Query Manager (port 8001):"
	@curl -s -f http://localhost:8001/health > /dev/null && echo "âœ… Connected" || echo "âŒ Not available"
	@echo "Story Manager (port 8002):"
	@curl -s -f http://localhost:8002/health > /dev/null && echo "âœ… Connected" || echo "âŒ Not available"
	@echo "Insights Backend (port 8004):"
	@curl -s -f http://localhost:8004/health > /dev/null && echo "âœ… Connected" || echo "âŒ Not available"

# Database shell
db-shell:
	@echo "ğŸ˜ Connecting to PostgreSQL shell..."
	docker-compose exec postgres psql -U dagster -d dagster

# Database backup
db-backup:
	@echo "ğŸ’¾ Backing up Dagster database..."
	@TIMESTAMP=$$(date +%Y%m%d_%H%M%S) && \
	docker-compose exec postgres pg_dump -U dagster -d dagster > backups/dagster_backup_$$TIMESTAMP.sql && \
	echo "âœ… Backup saved to backups/dagster_backup_$$TIMESTAMP.sql"

# Clean everything
clean:
	@echo "ğŸ§¹ Cleaning up all containers and volumes..."
	docker-compose down -v --remove-orphans
	@echo "ğŸ§¹ Removing unused images..."
	docker image prune -f
	@echo "âœ… Cleanup complete"

# Reset everything
reset: clean build up
	@echo "ğŸ”„ Reset complete"

# Development helpers
shell-web:
	@echo "ğŸš Opening shell in web container..."
	docker-compose exec asset-manager-web bash

shell-daemon:
	@echo "ğŸš Opening shell in daemon container..."
	docker-compose exec asset-manager-daemon bash

# Check environment file
check-env:
	@echo "ğŸ” Checking environment configuration..."
	@if [ -f .env ]; then \
		echo "âœ… .env exists"; \
		echo "ğŸ“‹ Environment variables:"; \
		grep -E '^[A-Z]' .env | head -10; \
		echo "..."; \
	else \
		echo "âŒ .env not found"; \
		echo "Please create .env file with required configuration"; \
	fi
