# Generic metadata about this project
name: tasks_manager
prefect-version: 3.4.8.dev6

# Build, push, and pull configuration for Git-based storage
build: null

push: null

pull:
- prefect.deployments.steps.set_working_directory:
    directory: "/opt/prefect/tasks_manager"


# Reusable definitions
definitions:
  work_pools:
    work_pool: &work_pool
      name: tasks-manager-process-pool
      work_queue_name: default

# Deployments configuration
deployments:


- name: "process-story-alerts"
  version: "1.0.0"
  description: "Process stories and trigger relevant alerts"
  entrypoint: tasks_manager.flows.alerts:process_story_alerts
  work_pool: *work_pool
  triggers:
  - type: event
    name: "story-generated-trigger"
    description: "Triggered when stories are generated for a metric"
    enabled: true
    expect:
    - metric.story.generated
    parameters:
      metric_id: "{{ event.resource.metric_id }}"
      tenant_id: "{{ event.resource.tenant_id }}"
      story_date: "{{ event.resource.story_date }}"
      stories_str: "{{ event.payload.stories }}"

- name: "execute-alert"
  version: "1.0.0"
  description: "Execute a single alert"
  entrypoint: tasks_manager.flows.alerts:execute_alert
  work_pool: *work_pool
  triggers:
  - type: event
    name: "alert-execution-trigger"
    description: "Triggered when an alert needs to be executed"
    enabled: true
    expect:
    - alert.execution.requested
    parameters:
      tenant_id: "{{ event.resource.tenant_id }}"
      alert_id: "{{ event.resource.alert_id }}"
      trigger_params_str: "{{ event.payload.trigger_params }}"
